history.pushState({ page: 1 }, "Title 1", "#no-back");
window.onhashchange = function (event) {
    window.location.hash = "no-back";
};
function getPath(path) {
    if (appPath.length > 1)
        return appPath + path;
    else
        return path;

}
var showtime = 16000;
var elapsed_seconds2 = 8;



$(window).bind("load resize", function () {
    width = (this.window.innerWidth > 0) ? this.window.innerWidth : this.screen.width;
    if (width <= 768) {
        $("input.changeType").attr('type', 'number');
        elapsed_seconds2 = 2;
        showtime = 3000;
        //++++++++++++++++++++++++++++++++++++++++++++++++++++
        $(".actPass").addClass("hPass")
        $(".actPass").removeClass("passActive")
        $(".temPass").addClass("passActive")
        $(".temPass").removeClass("hPass")
    } else {
        $("input.changeType").attr('type', 'text');
        elapsed_seconds2 = 8;
        showtime = 9000;
        //++++++++++++++++++++++++++++++++++++++++++++++++++++
        $(".actPass").addClass("passActive")
        $(".actPass").removeClass("hPass")
        $(".temPass").addClass("hPass")
        $(".temPass").removeClass("passActive")
    }
});

function showMessage(t, m, dialogType) {
    var msgType = "";
    if (t === "i") {
        msgType = "alert-info";
    }
    if (t === "s") {
        msgType = "alert-success";
    }
    if (t === "w") {
        msgType = "alert-warning";
    }
    if (t === "d") {
        msgType = "alert-danger";
    }

    addClass(m, msgType, dialogType);
    if (dialogType === 1) {
        $("#msg1").removeClass("hidden");

    }
    $("html, body").animate({ scrollTop: "0px" }, 300);
}
function addClass(m, msgType, dialogType) {
    if (dialogType === 1) {
        $("#msg1").removeClass('alert-info');
        $("#msg1").removeClass('alert-success');
        $("#msg1").removeClass('alert-warning');
        $("#msg1").removeClass('alert-danger');
        $("#msg1").addClass(msgType);
        $("#spn1").text(m);
        $(".msgBox").removeClass("hidden");
    }

}
function removeMessage(messageId, spn) {


    $(".msgBox").addClass("hidden");
}
$(document).ready(function () {

    $("#refresh").on("click", function () {
        updateCaptcha();

    });
});

function cancel(state) {
    if (state == 0) {
        canceling();
    }
    else {
        $("#RModalCancel").modal();
    }



}
sessionCount();
function sessionCount() {
    $.ajax({
        url: getPath("/Payment/CountSessionCounter"),
        type: "POST",
        data: {},

        success: function (myString) {
            if (parseInt(myString) > 1) {
                cancel(0);
            }
        }

    });
}


$("#no").click(function () {
    $('#RModalCancel').modal('toggle');
});

$("#yes").click(function () {
    $.post("./done",function({
        cart : cart,
        userID : userID,
        tokenDiscount : tokenDiscount
    },status){
        alert(status);
    });
});

function canceling() {
    $.ajax({
        url: getPath("/Payment/Canceling"),
        type: "POST",
        data: {},

        success: function (dataw) {
            updateCaptcha();
            resetPassword();
            $("#postback").append(dataw);
        },
        error: function (xhr, ajaxOptions, thrownError) {
        }
    });
}

$("#cancel").click(function () {
    cancel(1);
});
function updateCaptcha() {
    jQuery('#captcha_img').attr('src', getPath("/Payment/getcaptcha?cb=") + (new Date().getTime()));
}
function resetPassword() {
    $("#p123").val("");
    $("#p1").val("");
    $("#pass_1").val("");
    $("#pass_2").val("");
    $(".bWrapper").empty();

}

$("#in1").on('keydown', keyLock);
$("#in2").on('keydown', keyLock);
$("#in3").on('keydown', keyLock);
$("#in4").on('keydown', keyLock);
$("#in5").on('keydown', keyLock);
$("#p1").on('keydown', keyLock);
$("#p123").on('keydown', keyLock);
$("#year").on('keydown', keyLock);
$("#month").on('keydown', keyLock);

function keyLock(e) {
    // Allow: backspace, delete, tab, escape, enter and .
    if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
        // Allow: Ctrl+A, Command+A
        (e.keyCode == 65 && (e.ctrlKey === true || e.metaKey === true)) ||
        // Allow: home, end, left, right, down, up
        (e.keyCode >= 35 && e.keyCode <= 40)) {
        // let it happen, don't do anything
        return;
    }
    // Ensure that it is a number and stop the keypress
    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
        e.preventDefault();
    }
}



function get_elapsed_time_string(totalSeconds) {
    function prettyTimeString(num) {
        return (num < 10 ? "0" : "") + num;
    }

    var hours = Math.floor(totalSeconds / 3600);
    totalSeconds = totalSeconds % 3600;

    var minutes = Math.floor(totalSeconds / 60);
    totalSeconds = totalSeconds % 60;

    var seconds = Math.floor(totalSeconds);

    // Pad the minutes and seconds with leading zeros, if required
    hours = prettyTimeString(hours);
    minutes = prettyTimeString(minutes);
    seconds = prettyTimeString(seconds);

    // Compose the string for display
    var currentTimeString = hours + ":" + minutes + ":" + seconds;

    return currentTimeString;
}

function ResultData() {
    $.ajax({
        url: getPath("/Payment/GetPaymentInfo"),
        type: "POST",
        data: "",
        success: function (dataw) {
            $("#r_custId").text(dataw.CustomerId);
            $("#r_refId").text(dataw.ReferenceNumber);
            $("#r_pan").text(dataw.CardNo);
            $("#r_bank").text(dataw.BankName);
            $("#r_date").text(dataw.DateTime);

        },
        error: function (xhr, ajaxOptions, thrownError) {

        }
    });
}

$("#paymentBtn").click(function () {
    if (Bin() && CheckEmpty()) {

        if (isValidMonth()) {

            var cardNo = $("#in1").val() + $("#in2").val() + $("#in3").val() + $("#in4").val() + $("#in5").val();
            var cvv2 = $("#p123").val();
            var pin2 = $("#p1").val();
            var year = $("#year").val();
            var month = $("#month").val();

            var allAmount = $("#allAmount").text();
            var emailAddress = $("#email").val();
            var captcha = $("#p1234").val();


            

            $.ajax({
                url: getPath("/Payment/PaymentInfo"),
                type: "POST",
                data: { 'cardNo': cardNo, 'cvv2': cvv2, 'year': year, 'month': month, "allAmount": allAmount, "captcha": captcha, "pin2": pin2, "emailAddress": emailAddress },

                success: function (dataw) {

                    if (dataw.Code > parseInt(499) || dataw.Code == 131 || dataw.Code == 120 || dataw.Code == 160 || dataw.Code == 130 || dataw.Code == 133) {
                        showMessage("d", dataw.Text, 1);
                        updateCaptcha();
                        resetPassword();
                    } else {
                        $("#main").hide();
                        $("#receipt").show();
                        SetTimer2();
                        ResultData();
                        if (dataw.Code === "100") {
                            $("#resultMessage").text("تراکنش  با موفقیت انجام شد");

                            $("#icon1").removeClass("hide");

                            disable();
                            setTimeout(explode, showtime);
                        } else {
                            $("#resultMessage").text(dataw.Text);
                            $("#icon2").removeClass("hide");
                            disable();
                            setTimeout(explode, showtime);
                            updateCaptcha();
                        }
                    }

                },
                error: function (xhr, ajaxOptions, thrownError) {

                    showMessage("d", "عملیات با مشکل مواجه شد لطفا دقایقی دیگر تلاش فرمایید", 1);
                    setTimeout(explode, showtime);
                    updateCaptcha();
                }
            });
        }
    }
    return false;
});

$("#sendAcceptor").click(function () {
    explode();
});

function disable() {
    $('#in1').attr('readonly', true);
    $('#in2').attr('readonly', true);
    $('#in3').attr('readonly', true);
    $('#in4').attr('readonly', true);
    $('#in5').attr('readonly', true);
    $('#p1').attr('readonly', true);
    $('#p123').attr('readonly', true);
    $('#paymentBtn').attr('disabled', 'disabled');
    $('#cancel').attr('disabled', 'disabled');
    $('#refresh').attr('disabled', 'disabled');
    $('#month').attr('readonly', true);
    $('#year').attr('readonly', true);
    $('#email').attr('readonly', true);
    $('#reemail').attr('readonly', true);
    $('#p1234').attr('readonly', true);

}

clear();
function clear() {
    $('#in1').val("");
    $('#in2').val("");
    $('#in3').val("");
    $('#in4').val("");
    $('#in5').val("");
    $('#p1').val("");
    $('#p123').val("");

    $('#month').val("");
    $('#year').val("");
    $('#email').val("");
    $('#reemail').val("");
    $('#p1234').val("");

}

function sendRequest() {
    $.ajax({
        url: getPath("/Payment/Webrequest"),
        type: "POST",

        success: function (dataw) {
            $("#postback").append(dataw);
        }
    });
}


function explode() {

    //showMessage("i", "در حال ارسال  اطلاعات به سایت پذیرنده", 1);
    sendRequest();
}



$("#reemail").focusout(function () {

    if (!ismatchEmailAddress($("#email").val(), $("#reemail").val())) {
        showMessage("d", "تکرار پست الکترونیکی اشتباه می باشد", 1);
    } else {
        removeMessage("#msg1", "#spn1");
    }
});

$("#in2").focusout(function () {

    checkBin19char();
});

function isValidEmailAddress(emailAddress) {
    var pattern = new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);
    return pattern.test(emailAddress);
};

function objectFind(array, value) {
    for (var i = 0; i < array.length; i++) {
        if (array[i] === value) {
            return array[i];
        }
    }
    return null;
}


function isValidMonth() {
    var a = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];

    if (objectFind(a, $("#month").val()) != null && $.isNumeric($("#month").val()) && $("#month").val().length == 2 && $.isNumeric($("#year").val()) && $("#year").val().length == 2) {

        return true;
    } else {
        showMessage("d", "تاریخ انقضا کارت نا معتبر می باشد", 1);
        return false;
    }

}

function checkBin19char() {
    var a = ["589210", "627353"];
    if (objectFind(a, $("#in1").val() + $("#in2").val().substring(0, 2)) != null) {
        $('#in5').attr('readonly', false);
    } else {
        $('#in5').attr('readonly', true);
    }
}

function Bin() {
    var a = ["603769", "636214", "589210", "627488", "627648", "627760", "589463", "627353", "606256", "505785", "639346",
        "585947", "505801", "504706", "603799", "502229", "621986", "627412", "627961", "603770", "628023", "502908", "622106", "639347", "639344", "639607", "502806", "502938", "610433", "627381", "581874", "581672", "639599", "505809", "504172", "636949", "505416", "606373", "628157", "858983", "636795", "585983","507677"];
    if (objectFind(a, $("#in1").val() + $("#in2").val().substring(0, 2)) != null) {

        return true;
    } else {
        showMessage("d", "شماره کارت نا معتبر می باشد", 1);
        updateCaptcha();
        resetPassword();
        return false;
    }
}

function CheckEmpty() {
    // if ($("#in1").val() === "" || $("#in2").val() == "" || $("#in3").val() === "" || $("#in4").val() === "" || $("#p1").val() === "" || $("#p123").val() === "" || $("#month").val() === "" || $("#year").val() === "" || $("#email").val() === "" || $("#reemail").val() === "" || $("#p1234").val() === "") {
    if ($("#in1").val() === "" || $("#in2").val() == "" || $("#in3").val() === "" || $("#in4").val() === "" || $("#p1").val() === "" || $("#p123").val() === "" || $("#month").val() === "" || $("#year").val() === "" || $("#p1234").val() === "") {

        showMessage("d", "پر کردن تمامی فیلد ها الزامی می باشد", 1);
        return false;
    }
    return true;
}

function ismatchEmailAddress(emailAddress1, emailAddress2) {
    if (emailAddress1 === emailAddress2) {
        return true;
    } else {
        return false;
    }
};

var elapsed_seconds = 600;
var myVar = setInterval(function () {
    elapsed_seconds = elapsed_seconds - 1;
    $('#timer').text(get_elapsed_time_string(elapsed_seconds));
    if (elapsed_seconds === 0) {
        clearInterval(myVar);
        postback();

    }
}, 1000);


function SetTimer2() {
    var myVar2 = setInterval(function () {
        elapsed_seconds2 = elapsed_seconds2 - 1;
        $('#timer2').text(get_elapsed_time_string(elapsed_seconds2));
        if (elapsed_seconds2 === 0) {
            clearInterval(myVar2);

        }
    }, 1000);

}

function postback() {
    $.ajax({
        url: getPath("/Payment/Webrequest"),
        type: "POST",
        success: function (dataw) {
            $("#postback").append(dataw);
        }
    });
    $.ajax({
        url: getPath("/Payment/ClearSession"),
        type: "POST",
        success: function (dataw) {

        }
    });


};

//$("#p123").focusout( function () {

//$(".keypad-popup").css("display", "none");
//});

//$("#p1").focusout(function () {

//    $(".keypad-popup").css("display", "none");
//});
$("#month").focusin(function () {

    $(".keypad-popup").css("display", "none");
});

$("#p123").focusin(function () {

    $(".keypad-popup").css("display", "block");
});

$("#p1").focusin(function () {

    $(".keypad-popup").css("display", "block");
});







